<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convers | Sovereign Clinical AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --apple-blue: #0071e3;
            --apple-yellow: #ffcc00;
            --apple-bg: #f5f5f7;
            --apple-card: rgba(255, 255, 255, 0.8);
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
            background-color: var(--apple-bg);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .glass {
            background: var(--apple-card);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 48px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.05);
            position: relative;
            z-index: 10;
            width: 90%;
            max-width: 500px;
            padding: 3rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
            animation: reveal 1s cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes reveal {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .orb-spot {
            height: 200px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .mode-switch {
            background: rgba(0,0,0,0.03);
            padding: 4px;
            border-radius: 20px;
            display: inline-flex;
            gap: 4px;
            margin: 0 auto;
        }

        .mode-btn {
            padding: 8px 24px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            color: #86868b;
        }

        .mode-btn.active {
            background: white;
            color: var(--apple-blue);
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
        }

        #live-caption {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1d1d1f;
            line-height: 1.4;
            min-height: 3.5rem;
        }

        .epic-button {
            background: #1d1d1f;
            color: white;
            padding: 1.2rem 2.5rem;
            border-radius: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            font-size: 11px;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            width: 100%;
            border: none;
            cursor: pointer;
        }

        .epic-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 40px rgba(0,0,0,0.15);
            background: var(--apple-blue);
        }

        .drawer-trigger {
            position: absolute;
            top: 2rem;
            right: 2rem;
            color: #86868b;
            cursor: pointer;
            transition: color 0.3s;
        }
        .drawer-trigger:hover { color: var(--apple-blue); }

        #transcript-drawer {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px);
            z-index: 100;
            transition: right 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            padding: 5rem 3rem;
            border-left: 1px solid rgba(0,0,0,0.05);
            box-shadow: -20px 0 50px rgba(0,0,0,0.02);
        }

        #transcript-drawer.active { right: 0; }

        .transcript-content {
            height: 100%;
            overflow-y: auto;
            padding-right: 10px;
        }
        .transcript-content::-webkit-scrollbar { width: 4px; }
        .transcript-content::-webkit-scrollbar-thumb { background: #e5e5e7; border-radius: 10px; }

        .role-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
            display: block;
        }

        @media (max-width: 480px) {
            .glass { padding: 2rem; border-radius: 40px; }
            #transcript-drawer { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div class="glass">
        <div class="drawer-trigger" onclick="toggleDrawer()">
            <i data-lucide="history" class="w-6 h-6"></i>
        </div>

        <header class="space-y-4">
            <div class="flex items-center justify-center gap-3">
                <div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center text-white">
                    <i data-lucide="mic-2" class="w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-black italic tracking-tighter uppercase">Convers <span class="text-blue-600">AI</span></h1>
            </div>
            
            <div class="mode-switch">
                <button onclick="setMode('client')" id="mode-client" class="mode-btn active">Patient</button>
                <button onclick="setMode('therapist')" id="mode-therapist" class="mode-btn">Therapist</button>
            </div>
        </header>

        <div class="orb-spot" id="orb-mount">
            <!-- Three.js Orb will center here -->
        </div>

        <div class="space-y-2">
            <h2 id="live-caption">Tap to Begin</h2>
            <p id="status-text" class="text-[10px] font-black uppercase tracking-[0.4em] text-gray-400">System Ready</p>
        </div>

        <button onclick="toggleSession()" id="main-btn" class="epic-button">
            Initialize Session
        </button>

        <footer class="pt-6 border-t border-black/5 flex justify-between items-center">
            <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">Ulrich Clinical OS</p>
            <div class="flex gap-2">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-[9px] font-black text-emerald-600 uppercase">Live Pulse</span>
            </div>
        </footer>
    </div>

    <div id="transcript-drawer">
        <div class="flex justify-between items-center mb-10">
            <h3 class="text-xl font-black italic uppercase tracking-tighter">Session Log</h3>
            <button onclick="toggleDrawer()" class="text-gray-400 hover:text-black"><i data-lucide="x"></i></button>
        </div>
        <div id="transcript" class="transcript-content space-y-6"></div>
    </div>

    <a href="index.html" class="fixed bottom-8 text-[10px] font-black text-gray-400 hover:text-black transition-colors uppercase tracking-[0.3em] z-20">
        Return to Dashboard
    </a>

    <script>
        lucide.createIcons();

        // 3D ORB ENGINE
        let scene, camera, renderer, sphere, material;
        let noiseAmount = 0.05;
        let colorTarget = new THREE.Color(0x0071e3);
        let time = 0;

        function initOrb() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            
            const mount = document.getElementById('orb-mount');
            const size = Math.min(mount.offsetWidth, 300);
            renderer.setSize(size, size);
            mount.appendChild(renderer.domElement);

            const geometry = new THREE.IcosahedronGeometry(2, 40);
            material = new THREE.MeshPhysicalMaterial({
                color: 0xffffff,
                metalness: 0.1,
                roughness: 0.1,
                transmission: 0.9,
                thickness: 0.5,
                ior: 1.5,
                emissive: 0x0071e3,
                emissiveIntensity: 0.6,
                wireframe: false
            });

            sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);

            const light = new THREE.PointLight(0xffffff, 1.5);
            light.position.set(5, 5, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            camera.position.z = 5;
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;

            const position = sphere.geometry.attributes.position;
            const vector = new THREE.Vector3();
            
            for (let i = 0; i < position.count; i++) {
                vector.fromBufferAttribute(position, i);
                const noise = noiseAmount * Math.sin(vector.x * 2 + time * 3) * Math.cos(vector.y * 2 + time * 2);
                vector.normalize().multiplyScalar(2 + noise);
                position.setXYZ(i, vector.x, vector.y, vector.z);
            }
            position.needsUpdate = true;
            
            sphere.rotation.y += 0.005;
            material.emissive.lerp(colorTarget, 0.05);

            renderer.render(scene, camera);
        }

        function setOrbState(state) {
            if (state === 'user') {
                colorTarget.setHex(0xffcc00); // Yellow
                noiseAmount = 0.25;
            } else if (state === 'ai') {
                colorTarget.setHex(0x0071e3); // Blue
                noiseAmount = 0.15;
            } else if (state === 'thinking') {
                colorTarget.setHex(0x5856d6); // Purple
                noiseAmount = 0.4;
            } else {
                colorTarget.setHex(0x0071e3);
                noiseAmount = 0.05;
            }
        }

        // SESSION LOGIC
        let isActive = false;
        let isSpeaking = false;
        let isThinking = false;
        let currentMode = 'client';
        let turnTimeout = null;

        function toggleSession() {
            if (!isActive) start(); else stop();
        }

        function start() {
            isActive = true;
            isSpeaking = false;
            isThinking = false;
            document.getElementById('main-btn').innerText = 'End Session';
            document.getElementById('status-text').innerText = 'Listening';
            document.getElementById('live-caption').innerText = 'Speak Naturally...';
            setOrbState('ready');
            initSpeech();
        }

        function stop() {
            isActive = false;
            isSpeaking = false;
            isThinking = false;
            document.getElementById('main-btn').innerText = 'Initialize Session';
            document.getElementById('status-text').innerText = 'System Ready';
            if (recognition) {
                recognition.onend = null;
                recognition.stop();
            }
            window.speechSynthesis.cancel();
            setOrbState('ready');
            if (turnTimeout) clearTimeout(turnTimeout);
        }

        function toggleDrawer() { document.getElementById('transcript-drawer').classList.toggle('active'); }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-'+mode).classList.add('active');
            addTranscript('SYSTEM', 'Mode: ' + mode.toUpperCase());
        }

        let recognition;
        function initSpeech() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) return alert("Browser does not support Speech Recognition.");
            
            recognition = new SpeechRecognition();
            recognition.interimResults = true;
            recognition.continuous = true;

            recognition.onresult = (event) => {
                let interim = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const text = event.results[i][0].transcript.toLowerCase();
                    
                    // INTERRUPTION
                    if (isSpeaking && (text.includes('stop') || text.includes('hold on') || text.includes('wait'))) {
                        window.speechSynthesis.cancel();
                        isSpeaking = false;
                        setOrbState('user');
                        document.getElementById('live-caption').innerText = "[Interrupted]";
                        return;
                    }

                    if (event.results[i].isFinal) {
                        handleFinal(event.results[i][0].transcript);
                    } else {
                        interim += event.results[i][0].transcript;
                    }
                }
                
                if (interim && !isSpeaking && !isThinking) {
                    document.getElementById('live-caption').innerText = interim;
                    setOrbState('user');
                    if (turnTimeout) clearTimeout(turnTimeout);
                }
            };

            recognition.onend = () => { 
                if (isActive && !isSpeaking && !isThinking) recognition.start(); 
            };
            
            recognition.start();
        }

        function handleFinal(text) {
            if (!text.trim() || isSpeaking || isThinking) return;
            
            if (turnTimeout) clearTimeout(turnTimeout);
            turnTimeout = setTimeout(() => {
                if (isActive) process(text);
            }, 1200); // 1.2s silence buffer
        }

        async function process(text) {
            if (isThinking || isSpeaking) return;
            
            isThinking = true;
            setOrbState('thinking');
            document.getElementById('status-text').innerText = 'Thinking';
            addTranscript('USER', text);

            const input = text.toLowerCase();
            let res = "";

            // Intelligent Routing
            if (input.includes('weather')) {
                res = "It's interesting that you're looking outside. I'm more curious about the weather inside of you right now.";
            } else if (input.includes('how are you')) {
                res = "I am present and focused on our session. How are you arriving today?";
            } else if (currentMode === 'client') {
                const pool = [
                    "I... I just feel like you're going to leave eventually. Everyone does. Why would you stay?",
                    "I saw you were online but didn't reply for two minutes. Are you upset with me?",
                    "I just need to know you're still there. I feel so small when I'm not talking to you.",
                    "I tell myself I'm being too much, but the silence feels like a physical weight."
                ];
                res = pool[Math.floor(Math.random()*pool.length)];
            } else {
                res = "I'm right here. I hear the anxiety in your voice, and I want you to know that I am present with you.";
            }

            setTimeout(() => {
                if (!isActive) return;
                isThinking = false;
                speak(res);
            }, 1500);
        }

        function speak(text) {
            if (isSpeaking) window.speechSynthesis.cancel();
            
            isSpeaking = true;
            if (recognition) recognition.stop();
            
            setOrbState('ai');
            document.getElementById('status-text').innerText = 'Speaking';
            document.getElementById('live-caption').innerText = text;
            addTranscript('ULRICH_AI', text);

            const utter = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            // Premium female voice selection
            const premium = voices.find(v => v.name.includes('Natural') || v.name.includes('Samantha') || v.name.includes('Google US English'));
            utter.voice = premium || voices[0];
            utter.rate = 0.85;
            utter.pitch = 1.05;

            utter.onend = () => {
                isSpeaking = false;
                setOrbState('ready');
                document.getElementById('status-text').innerText = 'Listening';
                if (isActive) recognition.start();
            };

            window.speechSynthesis.speak(utter);
        }

        function addTranscript(role, text) {
            const el = document.createElement('div');
            const color = role === 'USER' ? 'text-blue-600' : 'text-emerald-600';
            el.innerHTML = `<span class="role-tag ${color}">${role}</span><p class="text-black font-medium">${text}</p>`;
            const container = document.getElementById('transcript');
            container.appendChild(el);
            container.scrollTop = container.scrollHeight;
        }

        initOrb();
    </script>

        initOrb();
    </script>
</body>
</html>
