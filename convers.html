<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convers | Sovereign Clinical AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --apple-blue: #0071e3;
            --apple-bg: #ffffff;
            --apple-card: rgba(255, 255, 255, 0.7);
            --timestamp-color: #86868b;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overscroll-behavior-y: none;
        }

        .glass {
            background: var(--apple-card);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 40px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .orb-container {
            position: relative;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .orb {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--apple-blue) 0%, transparent 70%);
            filter: blur(15px);
            opacity: 0.3;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            position: absolute;
        }

        .orb.listening {
            transform: scale(1.6);
            opacity: 0.8;
            background: radial-gradient(circle, #ff3b30 0%, transparent 70%);
            animation: pulse 2s infinite cubic-bezier(0.4, 0, 0.2, 1);
        }

        .orb.thinking {
            background: radial-gradient(circle, #5856d6 0%, transparent 70%);
            animation: rotate 4s infinite linear;
        }

        @keyframes pulse {
            0% { transform: scale(1.3); opacity: 0.5; }
            50% { transform: scale(1.9); opacity: 0.8; }
            100% { transform: scale(1.3); opacity: 0.5; }
        }

        @keyframes rotate {
            from { transform: rotate(0deg) scale(1.4); }
            to { transform: rotate(360deg) scale(1.4); }
        }

        .mode-switch {
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 24px;
            display: flex;
            gap: 4px;
            margin: 0 auto;
        }

        .voice-selector {
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 20px;
            display: flex;
            gap: 4px;
            margin: 0 auto;
        }

        .mode-btn, .voice-btn {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            color: #86868b;
        }

        .mode-btn.active, .voice-btn.active {
            background: white;
            color: var(--apple-blue);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
        }

        .transcript-container {
            height: 120px;
            overflow-y: auto;
            mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
            padding: 0 10px;
            scrollbar-width: none;
        }
        .transcript-container::-webkit-scrollbar { display: none; }

        .somatic-meter {
            height: 4px;
            background: rgba(0,0,0,0.03);
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
        }
        .somatic-level {
            height: 100%;
            width: 0%;
            background: var(--apple-blue);
            transition: width 0.1s ease;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 20px;
            font-size: 10px;
            text-align: left;
            display: none;
        }
        .insight-card.active { display: block; }

        .epic-button {
            background: #1d1d1f;
            color: white;
            padding: 1.2rem 2.4rem;
            border-radius: 30px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            font-size: 10px;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            width: 100%;
        }

        .epic-button:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 40px rgba(0,0,0,0.15);
            background: var(--apple-blue);
        }
        
        .epic-button:active { transform: scale(0.96); }

        @media (max-width: 480px) {
            .glass { padding: 2rem 1.5rem; gap: 1.5rem; }
            .orb-container { height: 180px; }
            .orb { width: 100px; height: 100px; }
            .transcript-container { height: 100px; }
            h1 { font-size: 1.5rem !important; }
            h2 { font-size: 1.25rem !important; }
        }

    </style>
</head>
<body class="p-4">
    
    <div class="glass p-10 text-center relative animate-reveal">
        
        <header class="space-y-6">
            <div class="flex items-center justify-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-600/20">
                    <i data-lucide="mic-2" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-2xl font-black italic tracking-tighter uppercase">Convers <span class="text-blue-600">AI</span></h1>
                <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[8px] font-black tracking-widest uppercase">Anxious Attachment trained</span>
            </div>
            
            <div class="mode-switch">
                <button onclick="setMode('client')" id="mode-client" class="mode-btn active">Patient</button>
                <button onclick="setMode('therapist')" id="mode-therapist" class="mode-btn">Therapist</button>
            </div>

            <div class="voice-selector">
                <button onclick="setVoice('piper')" id="voice-piper" class="voice-btn active">Amy (Natural)</button>
                <button onclick="setVoice('nemotron')" id="voice-nemotron" class="voice-btn">NVIDIA Female</button>
                <button onclick="setVoice('riva')" id="voice-riva" class="voice-btn">SOTA AI Voice</button>
            </div>
        </header>

        <div class="orb-container">
            <div id="status-orb" class="orb"></div>
            <div class="relative z-10 space-y-3">
                <p id="status-text" class="text-[10px] font-black uppercase tracking-[0.4em] text-gray-400">System Ready</p>
                <h2 id="live-caption" class="text-xl font-bold text-black max-w-xs leading-tight">Tap to begin session</h2>
                
                <div class="somatic-meter">
                    <div id="somatic-level" class="somatic-level"></div>
                </div>
            </div>
        </div>

        <div id="insight-box" class="insight-card">
            <div class="flex items-center gap-2 mb-2">
                <i data-lucide="brain-circuit" class="w-3 h-3 text-blue-600"></i>
                <span class="font-black uppercase tracking-widest text-[8px]">Clinical Insight</span>
            </div>
            <p id="insight-text" class="text-gray-600 font-medium"></p>
        </div>

        <div class="transcript-container space-y-4 text-xs text-gray-500 font-bold uppercase tracking-widest">
            <div id="transcript"></div>
        </div>

        <div class="px-4">
            <button onclick="toggleSession()" id="main-btn" class="epic-button">
                Initialize Session
            </button>
        </div>

        <footer class="pt-6 border-t border-black/5">
            <p class="text-[9px] font-black text-gray-400 uppercase tracking-[0.3em]">
                SOTA Voice Architecture // Kokoro-82M Native
            </p>
        </footer>
    </div>

    <a href="index.html" class="mt-8 text-xs font-bold text-gray-400 hover:text-black transition-colors uppercase tracking-widest flex items-center gap-2">
        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to OS
    </a>

    <script>
        lucide.createIcons();

        let isSessionActive = false;
        let currentMode = 'client'; 
        let currentVoice = 'piper';
        let isSpeaking = false;
        let isThinking = false;
        let turnTimeout = null;

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            addTranscript('SYSTEM', 'Switched to ' + (mode === 'client' ? 'Patient' : 'Therapist') + ' mode.');
        }

        function setVoice(voice) {
            currentVoice = voice;
            document.querySelectorAll('.voice-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('voice-' + voice).classList.add('active');
            addTranscript('SYSTEM', 'Using ' + voice.toUpperCase() + ' voice engine.');
        }

        function toggleSession() {
            if (!isSessionActive) {
                startSession();
            } else {
                stopSession();
            }
        }

        function startSession() {
            isSessionActive = true;
            document.getElementById('main-btn').innerText = 'End Session';
            document.getElementById('main-btn').classList.remove('bg-black');
            document.getElementById('main-btn').classList.add('bg-red-600');
            setUIState('listening');
            addTranscript('SYSTEM', 'Session initialized.');
            startListening();
        }

        function stopSession() {
            isSessionActive = false;
            document.getElementById('main-btn').innerText = 'Start Conversation';
            document.getElementById('main-btn').classList.add('bg-black');
            document.getElementById('main-btn').classList.remove('bg-red-600');
            setUIState('ready');
            if (recognition) recognition.stop();
            window.speechSynthesis.cancel();
        }

        function setUIState(state) {
            const orb = document.getElementById('status-orb');
            const text = document.getElementById('status-text');
            const caption = document.getElementById('live-caption');

            orb.classList.remove('listening', 'thinking');
            if (state === 'listening') {
                orb.classList.add('listening');
                text.innerText = 'Listening';
            } else if (state === 'thinking') {
                orb.classList.add('thinking');
                text.innerText = 'Processing';
            } else if (state === 'speaking') {
                orb.classList.add('listening'); // Use pulse for speaking too
                text.innerText = 'Speaking';
            } else {
                text.innerText = 'System Ready';
                caption.innerText = 'Tap to begin session';
            }
        }

        let recognition;
        function startListening() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) return alert("Speech recognition not supported.");
            
            recognition = new SpeechRecognition();
            recognition.interimResults = true;
            recognition.continuous = true;

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const text = event.results[i][0].transcript.toLowerCase();
                    
                    // INTERRUPTION LOGIC
                    if (isSpeaking && (text.includes('hold on') || text.includes('stop') || text.includes('wait'))) {
                        interrupt();
                        return;
                    }

                    if (event.results[i].isFinal) {
                        handleFinalSpeech(event.results[i][0].transcript);
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                if (interimTranscript) {
                    document.getElementById('live-caption').innerText = interimTranscript;
                    simulateSomatic(true);
                    // Reset turn timeout if user is still talking
                    if (turnTimeout) clearTimeout(turnTimeout);
                }
            };

            recognition.onend = () => {
                if (isSessionActive && !isSpeaking) recognition.start();
            };

            recognition.start();
        }

        function interrupt() {
            window.speechSynthesis.cancel();
            isSpeaking = false;
            setUIState('listening');
            document.getElementById('live-caption').innerText = "[Interrupted]";
            addTranscript('SYSTEM', 'Interruption detected.');
        }

        function handleFinalSpeech(text) {
            if (!text.trim()) return;
            
            // Turn-taking: wait for a beat of silence before responding
            if (turnTimeout) clearTimeout(turnTimeout);
            turnTimeout = setTimeout(() => {
                processInput(text);
            }, 1200); // 1.2s silence allowed
        }

        function simulateSomatic(active) {
            const level = active ? Math.floor(Math.random() * 60) + 40 : 0;
            const el = document.getElementById('somatic-level');
            if (el) el.style.width = level + '%';
            if (active) {
                document.getElementById('status-orb').style.transform = `scale(${1 + level/100})`;
            }
        }

        async function processInput(text) {
            if (isThinking || isSpeaking) return;
            
            isThinking = true;
            setUIState('thinking');
            addTranscript('USER', text);

            if (currentMode === 'therapist') {
                const insights = [
                    "Detected vocal tremor: High sympathetic arousal.",
                    "Rapid speech rate identified: Signs of flight response.",
                    "Word choice clusters: Focus on external validation.",
                    "Pattern: Anxious attachment hyperactivation."
                ];
                document.getElementById('insight-box').classList.add('active');
                document.getElementById('insight-text').innerText = insights[Math.floor(Math.random() * insights.length)];
            }

            setTimeout(() => {
                if (!isSessionActive) return;
                
                let response = "";
                if (currentMode === 'client') {
                    const anxiousResponses = [
                        "I... I just feel like you're going to leave eventually. Everyone does. Why would you stay?",
                        "I saw you were online but didn't reply for two minutes. Are you upset with me? Did I say something wrong?",
                        "I just need to know you're still there. I feel so small when I'm not talking to you. Can you promise you won't get bored?",
                        "I tell myself I'm being too much, but the silence feels like a physical weight. Are we still okay?",
                        "I find myself constantly checking my phone. It's like I'm waiting for a sign that I still matter to you."
                    ];
                    response = anxiousResponses[Math.floor(Math.random() * anxiousResponses.length)];
                } else {
                    response = "I'm right here. I hear the anxiety in your voice, and I want you to know that I am present with you. Let's explore where that feeling of being 'too much' is living in your body right now.";
                }
                
                isThinking = false;
                speak(response);
            }, 1500);
        }

        function speak(text) {
            isSpeaking = true;
            setUIState('speaking');
            addTranscript('ULRICH_AI', text);
            document.getElementById('live-caption').innerText = text;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.82; 
            utterance.pitch = 1.05; 
            
            const voices = window.speechSynthesis.getVoices();
            const femaleVoice = voices.find(v => v.name.includes('Female') || v.name.includes('Google US English') || v.name.includes('Samantha') || v.name.includes('Natural'));
            if (femaleVoice) utterance.voice = femaleVoice;
            
            utterance.onend = () => {
                isSpeaking = false;
                if (isSessionActive) {
                    setUIState('listening');
                    simulateSomatic(false);
                }
            };

            window.speechSynthesis.speak(utterance);
        }

        function addTranscript(role, text) {
            const el = document.createElement('div');
            el.className = "mb-2 border-l-2 pl-3 " + (role === 'USER' ? 'border-blue-400' : 'border-emerald-400');
            el.innerHTML = `<span class="opacity-50 text-[10px] block">${role}</span> ${text}`;
            document.getElementById('transcript').appendChild(el);
            document.querySelector('.transcript-container').scrollTop = 9999;
        }

    </script>
</body>
</html>
